import{i as h,r as y,a as c,h as s,b,p as d}from"./sounds-6715028d.js";import{i as A,g as r}from"./job-c833d8dd.js";import{t as e}from"./translate-8d8a5063.js";import{t as m}from"./layers-e0032f78.js";import{i as W}from"./secretPassages-595cd545.js";import{o as u}from"./discussion-954a399d.js";import{n as v}from"./notifications-815648e0.js";import{h as S}from"./workadventureFeatures-48ab46db.js";let n=null,l=null;const C=async()=>{const o=await WA.player.getPosition();WA.camera.set(o.x,o.y,100,100)};WA.onInit().then(async()=>{WA.camera.followPlayer(!0),WA.camera.set(665,838),await A(),S(),h([{name:"evilGuySound",path:"evilGuy.mp3"}]);const o=WA.sound.loadSound(`${y}/sounds/bomb.mp3`);o.play({volume:.3,loop:!0,rate:1,detune:1,delay:0,seek:0,mute:!1}),C(),u(e("utils.mySelf"),e(`bomb.story.${r()}`),"views.choice.close","discussion","middle","middle","50vh","50vh",()=>{s("freeSpy")?(m("rock",!1),WA.room.setTiles([{x:15,y:7,tile:null,layer:"rockCollisions"},{x:15,y:8,tile:null,layer:"rockCollisions"}])):r()==="spy"&&(WA.controls.disablePlayerControls(),WA.player.setOutlineColor(255,0,0))}),WA.player.state.askForDefuseBomb=!1,WA.player.state.askForBoom=!1,W(["secretPassage"],[()=>{console.log("secret passage discovered !")}]),c("freeSpy",()=>{m("rock",!1),WA.room.setTiles([{x:15,y:7,tile:null,layer:"rockCollisions"},{x:15,y:8,tile:null,layer:"rockCollisions"}]),r()==="spy"&&(WA.player.removeOutlineColor(),WA.controls.restorePlayerControls())}),c("boom",()=>{o.stop(),WA.ui.actionBar.removeButton("cheatSheetButton"),d("evilGuySound"),u(e("bomb.bomb.failure.name"),e("bomb.bomb.failure.message"),"views.choice.close","discussion","middle","middle","50vh","50vh",()=>{r()==="spy"&&WA.controls.disablePlayerControls()})}),c("defuseBomb",()=>{m("bomb",!1),p(),o.stop(),WA.ui.actionBar.removeButton("cheatSheetButton"),d("successSound"),v(e("bomb.bomb.success"),e("utils.success"),"success")}),r()==="spy"&&(WA.player.state.askForCloseCheatSheet=!1,WA.ui.actionBar.addButton({id:"cheatSheetButton",label:e("bomb.cheatSheet"),callback:async()=>{l?f():await w()}}),WA.player.state.onVariableChange("askForCloseCheatSheet").subscribe(i=>{i&&f()}));let a=null;WA.room.onEnterLayer("saveSpyZone").subscribe(()=>{!s("boom")&&!s("defuseBomb")?u(e("utils.mySelf"),e("bomb.freeSpy.noTime"),"views.choice.close","discussion"):s("freeSpy")||(a=WA.ui.displayActionMessage({message:e("utils.executeAction",{action:e("bomb.freeSpy.free")}),callback:()=>{b("freeSpy")}}),WA.room.onLeaveLayer("saveSpyZone").subscribe(()=>{a==null||a.remove(),a=null}))});let t=null;WA.room.onEnterLayer("bombZone").subscribe(()=>{!s("boom")&&!s("defuseBomb")&&(t=WA.ui.displayActionMessage({message:e("utils.executeAction",{action:e("bomb.bomb.defuse")}),callback:async()=>{WA.controls.disablePlayerControls(),n=await WA.ui.website.open({url:`${y}/views/bomb/bomb.html`,allowApi:!0,allowPolicy:"",position:{vertical:"middle",horizontal:"middle"},size:{height:"50vh",width:"50vw"}})}})),WA.room.onLeaveLayer("bombZone").subscribe(()=>{t==null||t.remove(),t=null})}),WA.player.state.onVariableChange("askForBoom").subscribe(i=>{i&&(p(),b("boom"))}),WA.player.state.onVariableChange("askForDefuseBomb").subscribe(i=>{i&&b("defuseBomb")})});const w=async()=>{l=await WA.ui.website.open({url:`${y}/views/bomb/cheatSheet.html`,allowApi:!0,allowPolicy:"",position:{vertical:"middle",horizontal:"middle"},size:{height:"50vh",width:"50vw"}})},f=()=>{l==null||l.close(),l=null,WA.player.state.askForCloseCheatSheet=!1},p=()=>{n&&(n.close(),n=null,WA.controls.restorePlayerControls())};
